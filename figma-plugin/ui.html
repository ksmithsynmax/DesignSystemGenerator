<!DOCTYPE html>
<html>
<head>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: #1e1e1e;
      color: #ccc;
      padding: 12px;
      font-size: 12px;
    }
    #status {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 12px;
      padding: 8px 12px;
      background: #2a2a2a;
      border-radius: 6px;
    }
    #status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #868e96;
    }
    #status-dot.connected { background: #51cf66; }
    #status-dot.connecting { background: #fab005; }
    #status-dot.error { background: #fa5252; }
    #log {
      background: #111;
      border-radius: 6px;
      padding: 8px;
      max-height: 140px;
      overflow-y: auto;
      font-family: monospace;
      font-size: 10px;
      line-height: 1.6;
    }
    .log-line { color: #868e96; }
    .log-line.recv { color: #74c0fc; }
    .log-line.send { color: #69db7c; }
    .log-line.err { color: #ff6b6b; }
  </style>
</head>
<body>
  <div id="status">
    <div id="status-dot"></div>
    <span id="status-text">Disconnected</span>
  </div>
  <div id="log"></div>

  <script>
    const WS_URL = "ws://localhost:9001";
    let ws = null;
    let reconnectTimer = null;

    function setStatus(state, text) {
      const dot = document.getElementById("status-dot");
      dot.className = state;
      document.getElementById("status-text").textContent = text;
    }

    function log(dir, text) {
      const el = document.getElementById("log");
      const line = document.createElement("div");
      line.className = "log-line " + dir;
      const ts = new Date().toLocaleTimeString();
      line.textContent = `[${ts}] ${dir}: ${text}`;
      el.prepend(line);
      while (el.children.length > 50) el.removeChild(el.lastChild);
    }

    function connect() {
      setStatus("connecting", "Connecting...");

      try {
        ws = new WebSocket(WS_URL);
      } catch (e) {
        setStatus("error", "Failed to connect");
        reconnectTimer = setTimeout(connect, 3000);
        return;
      }

      ws.onopen = () => {
        setStatus("connected", "Connected to relay");
        log("send", "register as plugin");
        ws.send(JSON.stringify({ type: "register", role: "plugin" }));
      };

      ws.onmessage = (event) => {
        let msg;
        try {
          msg = JSON.parse(event.data);
        } catch {
          return;
        }

        log("recv", msg.type + (msg.message ? ": " + msg.message : ""));

        if (msg.type === "sync-tokens") {
          // Forward token payload to plugin main thread
          parent.postMessage({ pluginMessage: { type: "sync-tokens", payload: msg.payload } }, "*");
        } else if (msg.type === "peer-connected") {
          log("recv", "React app connected");
        } else if (msg.type === "peer-disconnected") {
          log("recv", "React app disconnected");
        }
      };

      ws.onclose = () => {
        setStatus("", "Disconnected");
        log("err", "Connection lost, reconnecting...");
        ws = null;
        reconnectTimer = setTimeout(connect, 3000);
      };

      ws.onerror = () => {
        ws.close();
      };
    }

    // Receive messages from plugin main thread
    window.onmessage = (event) => {
      if (!event.data || !event.data.pluginMessage) return;
      const msg = event.data.pluginMessage;

      log("send", msg.type + (msg.message ? ": " + msg.message : ""));

      // Forward status back to React app through relay
      if (ws && ws.readyState === 1) {
        ws.send(JSON.stringify(msg));
      }
    };

    connect();
  </script>
</body>
</html>
